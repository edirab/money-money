<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Money simple</title>
    <!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>-->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
</head>
<body>


    <div id="canvas-holder" style="width:40%; margin:0 auto; max-height: 500px;">

            <h3>Калькулятор денег с использованием Chart.js</h3>

        <table id="inputs">
            <tr>
                <td><label for="on_debet">На карте</label></td>
                <td><input type="text" id="on_debet"></td>
            </tr>
            <tr>
                <td><label for="in_dollars">В долларах</label></td>
                <td><input type="text" id="in_dollars"></td>
            </tr>
            <tr>
                <td><label for="in_euro">В евро</label></td>
                <td><input type="text" id="in_euro"></td>
            </tr>
            <tr>
                <td><label for="in_safe">В сейфе</label></td>
                <td><input type="text" id="in_safe"></td>
            </tr>
            <tr>
                <td><label for="in_wallet">В кошельке</label></td>
                <td><input type="text" id="in_wallet"></td>
            </tr>

            <tr>
                <td><button type="button" id="button">Отрисовать</button></td>
            </tr>
        </table>

        <canvas id="moneyChart" width="400" height="400"></canvas>

        <div style="margin:0 auto;">
            <p id="total" style=" margin:0 auto;" ></p>
        </div>

    </div>


    <!--<script type="text/javascript" scr="Chart.js"></script>-->
    <script type="text/javascript">
        
        var global_sum = 0;
        var ctx2 = document.getElementById("moneyChart").getContext('2d');

    // Составные части объекта ДЕНЬГИ
        // Названия на русском
        cash_name = ["На карте", "В долларах", "В евро", "Наличные в сейфе", "В кошельке"];
        // Величина в номинальных единицах
        cash_nominal = [46000, 600, 770, 25000, 2300];
        // Коэффициенты пересчёта в Рубли (!)
        exchange_coeff = [1, 67, 75, 1, 1];

        // Массив дял процентов
        cahs_perсents = new Array(cash_name.length);
        // Массив для меток на графике
        cash_label = new Array(cash_name.length);
        // Метки элементов input
        cash_input_id = ["on_debet", "in_dollars", "in_euro", "in_safe", "in_wallet"];
        // Массив для построения самой диаграммы
        cash_in_rubs = new Array(cash_name.length);


        checkLocalStorage();

        // Prepopulating inputs
        for (var i = 0; i < cash_label.length; i++){
            document.getElementById(cash_input_id[i]).value = String(cash_nominal[i]);
        }

        countSum();
        countPercent();
        prepareDataForChart();

        var moneyDoughnutChart = new Chart(ctx2, {
            type: 'doughnut',
            data: {
            labels: cash_label,
                datasets: [{
                label: '# of Votes',
                data: cash_in_rubs,
                backgroundColor: [
                    'rgba(255, 99, 132, 0.2)',
                    'rgba(54, 162, 235, 0.2)',
                    'rgba(255, 206, 86, 0.2)',
                    'rgba(75, 192, 192, 0.2)',
                    'rgba(153, 102, 255, 0.2)',
                    'rgba(255, 159, 64, 0.2)'
                ],
                borderColor: [
                    'rgba(255,99,132,1)',
                    'rgba(54, 162, 235, 1)',
                    'rgba(255, 206, 86, 1)',
                    'rgba(75, 192, 192, 1)',
                    'rgba(153, 102, 255, 1)',
                    'rgba(255, 159, 64, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {}
        });


        /*
        *   HELPER FUNCTIONS
        *
        * */

        // Расчёт суммы
        function countSum(){
            global_sum = 0;
            for (var i = 0; i < cash_nominal.length; i++ ){
                global_sum += cash_nominal[i] * exchange_coeff[i];
                //alert(sum);
            }
            //alert(sum);
            document.getElementById("total").innerHTML = "Всего " + String(global_sum) + " руб.";
        }

        // Расчёт процентов
        function countPercent() {
            for (var i = 0; i < cash_nominal.length; i++ ){
                var amount_in_percent = ( cash_nominal[i] * exchange_coeff[i] ) / global_sum * 100;
                amount_in_percent = amount_in_percent.toFixed(1);
                cash_label[i] = cash_name[i] +  " - " + String(amount_in_percent)+ "%: ";
            }
        }

        // Обработчик кнопки
        document.getElementById('button').addEventListener('click', function(){
            for (var i = 0; i < cash_nominal.length; i++ ){
                cash_nominal[i] = Number( document.getElementById(cash_input_id[i]).value);

                localStorage.setItem(String(cash_name[i]), String(cash_nominal[i]));
            }

            countSum();
            countPercent();
            prepareDataForChart();
            moneyDoughnutChart.update();
        });


        // Проверка локального хранилища
        function checkLocalStorage(){
            try{
                for(var i = 0; i < cash_name.length; i++){
                    cash_value = localStorage.getItem(String(cash_name[i]));
                    if(cash_value !== null) {
                        cash_nominal[i] = cash_value;
                    }
                    else { break; }
                }
            }
            catch (err){}
        }

        // Готовим данные для диаграммы
        function prepareDataForChart() {
            for(var i = 0; i < cash_name.length; i++){
                cash_in_rubs[i] = cash_nominal[i] * exchange_coeff[i];
            }
        }

        function drawInputs(){
            for (var i = 0; i < cash_name.length; i++){
                document.getElementById("inputs").innerHTML += "<tr><td><label for=" + String(cash_input_id[i]) + ">" + String(cash_name[i]) + "</label></td>";
            /*
            *   <td><input type="text" id="on_debet"></td>
                        </tr>
            * */
            }
        }

    </script>

</body>
</html>